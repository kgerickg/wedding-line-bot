# 婚禮Line Bot 需求文件

## 1. 產品目標
建立一個婚禮Line Bot，讓賓客能夠：
- 查詢自己的座位桌號（輸入姓名）
- 查看婚紗照（隨機一張）
- 支援中英文雙語
- 使用者體驗優化，功能入口以按鈕選單呈現

---

## 2. 功能需求

### 2.1 座位查詢
- 使用者加入Line Bot後，顯示「座位查詢」和「婚紗照」兩個選項按鈕（Quick Reply 或 Rich Menu）
- 點選「座位查詢」或「Seat Lookup」後，Bot回覆查詢說明（中英文），引導輸入姓名
- 使用者輸入姓名（如：黃莉方）
- Bot回覆該賓客的桌號（如：第19~20桌），並附上桌次圖（該桌有明顯標註）
- 若查無此人，回覆「查無此人，請重新輸入」＋英文

### 2.2 婚紗照
- 點選「婚紗照」或「Wedding Photo」按鈕，Bot隨機回傳一張你提供的婚紗照 ✅ 已完成
- 支援從 Imgur 相簿獲取照片，提供高速載入體驗 ✅ 已完成
- 實作智能照片快取機制，避免頻繁呼叫外部 API ✅ 已完成

### 2.3 雙語支援
- 所有回覆皆同時顯示中英文

### 2.4 資料來源
- 座位表：支持兩種方式
  - Google Sheets ✅ 已實現，提供線上編輯和實時更新功能
  - 本地CSV文件：data/guest.csv（欄位：姓名、桌號）
- 桌次圖：你提供範本圖，協助產生每桌標註圖(public/tables)
- 婚紗照：支援兩種方式
  - 本地照片：存放於 data/pictures/ 目錄
  - Imgur 相簿：線上管理照片，無需重新部署 ✅ 已實現

---

## 3. User Story

- **賓客**：想查詢自己的座位，能快速知道在哪一桌
- **賓客**：想看婚紗照，能隨機看到一張 ✅ 已完成
- **賓客**：希望操作直覺，直接點選功能按鈕
- **賓客**：輸入錯誤姓名時收到友善提示
- **主辦方**：想隨時更新賓客名單，無需重新部署服務 ✅ 已通過Google Sheets實現
- **主辦方**：想隨時更新婚紗照，無需重新部署服務 ✅ 已通過Imgur API實現

---

## 4. 測試案例

1. **正常查詢**
   - 點選「座位查詢」→ 回覆查詢說明（中英文）
   - 輸入正確姓名→ 回覆桌號＋桌次圖（中英文）

2. **查無此人**
   - 輸入不存在的姓名→ 回覆「查無此人，請重新輸入」＋英文

3. **婚紗照** ✅ 已完成測試
   - 點選「婚紗照」→ 隨機回傳一張婚紗照（中英文說明）
   - 測試 Imgur 照片快取機制→ 快速回應

4. **英文查詢** (🔄 開發中)
   - 點選「Seat Lookup」或「Wedding Photo」→ 回覆同上

5. **選單體驗** ✅ 已完成CLI實現
   - 新用戶加入時，能直接看到「座位查詢」和「婚紗照」按鈕

6. **Google Sheets整合** ✅ 已完成
   - 在Google Sheets中更新賓客資料→ 系統能自動獲取更新

7. **Imgur整合** ✅ 已完成
   - 在Imgur相簿中添加/刪除照片→ 系統能自動獲取更新
   - 測試快取刷新→ 透過指令或CLI更新照片快取

---

## 5. 非功能需求

- 部署於Google Cloud Functions，資料來源為Google Sheet ✅ Google Sheets整合已實現
- 圖片儲存於imgur或其他可公開連結 ✅ Imgur API整合已實現
- 介面簡潔，適合手機Line顯示
- 無需記錄查詢紀錄
- 自動錯誤處理和降級機制（例如：Sheet讀取失敗時自動使用CSV） ✅ 已實現
- 照片服務高效能與可靠性（Imgur讀取失敗時自動降級到本地照片） ✅ 已實現

---

## 6. 技術建議

- 使用Line官方SDK（Node.js/Python皆可）
- Google Cloud Functions免費額度足夠
- Google Sheet API存取座位資料、工作人員ID
  - 使用googleapis Node.js客戶端 ✅ 已實現
  - 資料緩存機制避免過度API調用 ✅ 已實現（5分鐘緩存）
- Imgur API存取婚紗照片
  - 使用imgur Node.js客戶端 ✅ 已實現
  - 照片快取機制避免頻繁API調用 ✅ 已實現（1小時更新）
- Quick Reply或Rich Menu設計選單

---

## 7. 交接與協作建議

- 將本需求文件（建議放在README.md或docs/需求說明.md）放進專案根目錄，方便團隊成員查閱
- 建立docs/資料夾，放置需求文件、API設計、測試案例等
- Google Sheet範例、桌次圖、婚紗照網址等測試資料也一併放進專案或docs/，方便他人測試
- 專案初始化腳本（如requirements.txt、package.json）也一併整理好
- 任何人只要clone專案、看文件、照著步驟就能無縫接手 

---

## 8. 專案結構

### 當前結構
```
marraige/
├── config/                 # 配置目錄
│   └── service-account-key.json # Google API服務帳號金鑰
├── data/                   # 資料目錄
│   ├── guests.csv          # 賓客名單和座位資料
│   ├── pictures/           # 婚紗照片目錄
│   └── tables/             # 桌次圖目錄
├── deployment/             # 部署腳本目錄
│   ├── cloud-deploy.sh     # 完整部署腳本
│   └── redeploy.sh         # 快速重新部署腳本
├── docs/                   # 文件目錄
│   ├── 需求說明.md          # 本文件
│   └── google_sheets_setup.md # Google Sheets整合指南
├── node_modules/           # NPM依賴套件目錄
├── public/                 # 公開資源目錄
│   ├── images/             # 圖片資源目錄
│   └── tables/             # 桌次圖目錄
├── scripts/                # 腳本目錄
│   ├── cli.js              # 命令列介面工具 ✅ 已完成
│   ├── create_rich_menu_image.html  # 建立Rich Menu圖片工具 ✅ 已完成
│   ├── elegant_wedding_map.html     # 桌次圖網頁生成工具
│   ├── generate_table_images.js     # 批量生成桌次圖腳本
│   ├── seat_search_icon.png         # 座位查詢圖示
│   ├── setupRichMenu.js             # 設置LINE Rich Menu的腳本
│   └── wedding_pic.png              # 婚紗照示例
├── src/                    # 源碼目錄
│   ├── app.js              # 應用程式主體
│   ├── controllers/        # 控制器目錄
│   ├── middlewares/        # 中間件目錄
│   ├── models/             # 資料模型目錄
│   ├── routes/             # 路由目錄
│   ├── services/           # 服務目錄
│   │   ├── guestService.js  # 座位查詢服務
│   │   ├── googleSheetsService.js # Google Sheets整合服務 ✅ 已完成
│   │   ├── photoService.js  # 照片服務 ✅ 已完成
│   │   └── richMenuService.js # Rich Menu服務
│   └── utils/              # 工具函數目錄
├── package-lock.json       # NPM套件版本鎖定檔
├── package.json            # 專案設定和依賴套件
├── README.md               # 專案說明文件
└── server.js               # 伺服器啟動檔
```

## 9. Google Sheets整合

### 實現功能
1. **雙重數據源支援**：同時支援CSV和Google Sheets，可透過配置切換
2. **自動降級機制**：如果Google Sheets讀取失敗，自動使用本地CSV作為備用
3. **緩存機制**：避免頻繁API調用，提高效能
4. **完整錯誤處理**：各層級均添加錯誤處理邏輯
5. **零停機更新**：無需重啟服務即可更新賓客資料

### 配置方法
使用Google Sheets需設置以下環境變數：
```
USE_GOOGLE_SHEETS=true
GOOGLE_APPLICATION_CREDENTIALS=./config/service-account-key.json
SHEETS_ID=您的試算表ID
SHEETS_RANGE=賓客名單!A:B
```

詳細配置步驟請參考 [Google Sheets整合指南](google_sheets_setup.md)。

## 10. Imgur API整合

### 實現功能
1. **雙重照片來源**：同時支援本地照片和Imgur相簿，可透過配置切換
2. **自動降級機制**：如果Imgur讀取失敗，自動使用本地照片作為備用
3. **智能快取系統**：記憶體快取相簿照片資訊，避免頻繁API調用
4. **定時更新機制**：每小時自動刷新快取，確保最新照片可用
5. **完整錯誤處理**：多層級錯誤處理和降級策略
6. **管理工具**：提供CLI和Line指令兩種方式刷新照片快取

### 配置方法
使用Imgur API需設置以下環境變數：
```
USE_IMGUR=true
IMGUR_CLIENT_ID=您的Imgur客戶端ID
IMGUR_ALBUM_HASH=您的相簿哈希值
```

詳細配置步驟請參考 [Imgur API整合指南](imgur_setup.md)。 